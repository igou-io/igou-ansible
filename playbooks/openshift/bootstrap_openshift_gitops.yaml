---
- hosts: "{{ ansible_limit | default('localhost') }}"
  name: Bootstrap Openshift Gitops and external-secrets operator, add an ansible serviceaccount and save the token to 1password
  gather_facts: false
  environment:
    KUBECONFIG: "{{ kubeconfig | default(omit)}}"
  tasks:
    - name: Create 1P Connect secrets, deploy and cluster-config application
      block:
        - name: Create Gitops namespace
          kubernetes.core.k8s:
            state: present
            definition:
              apiVersion: v1
              kind: Namespace
              metadata:
                name: openshift-gitops-operator
                labels:
                  openshift.io/cluster-monitoring: 'true'

        - name: Create Gitops OperatorGroup
          kubernetes.core.k8s:
            state: present
            definition:
              apiVersion: operators.coreos.com/v1
              kind: OperatorGroup
              metadata:
                name: openshift-gitops-operator
                namespace: openshift-gitops-operator
              spec:
                upgradeStrategy: Default

        - name: Create Gitops Subscription
          kubernetes.core.k8s:
            state: present
            definition:
              apiVersion: operators.coreos.com/v1alpha1
              kind: Subscription
              metadata:
                name: openshift-gitops-operator
                namespace: openshift-operators
              spec:
                channel: latest
                installPlanApproval: Automatic
                name: openshift-gitops-operator
                source: redhat-operators
                sourceNamespace: openshift-marketplace

        - name: create external secrets namespace
          kubernetes.core.k8s:
            state: present
            definition:
              apiVersion: v1
              kind: Namespace
              metadata:
                name: external-secrets-operator

        - name: Create 1password-token secret
          kubernetes.core.k8s:
            state: present
            definition:
              apiVersion: v1
              kind: Secret
              metadata:
                name: onepassword-token
                namespace: external-secrets-operator
                annotations:
                  managed-by: ansible
              type: Opaque
              stringData:
                token: "{{ onepassword_token }}"

      #   - name: Create Gitops ClusterRoleBinding
      #     kubernetes.core.k8s:
      #       state: present
      #       definition:
      #         kind: ClusterRoleBinding
      #         apiVersion: rbac.authorization.k8s.io/v1
      #         metadata:
      #           name: gitops-cluster-admin
      #         subjects:
      #           - kind: ServiceAccount
      #             name: openshift-gitops-argocd-application-controller
      #             namespace: openshift-gitops
      #         roleRef:
      #           apiGroup: rbac.authorization.k8s.io
      #           kind: ClusterRole
      #           name: cluster-admin

        - name: Create cluster-config application # Make cluster agnostic
          kubernetes.core.k8s:
            state: present
            definition: "{{ lookup('kubernetes.core.kustomize', enable_helm=True, dir='https://github.com/igou-io/igou-openshift/config/' + cluster_name + '/live/base-config/') }}"
          retries: 50
          delay: 15
      tags: create-objects