---
prerun: false
# Openshift-based testing template (CRC)
# CRC is quite rigid in configuration so many of these parameters are not configurable and thus there aren't default assertions for environment varibales
driver:
  name: default
  # If true, don't actually delete cluster in destroy step - Can be good for debugging, makes execution ignore cleanup variable
  persistent: false
  # Ignore cleanup errors
  cleanup_ignore_errors: true
  # crc setup configures the host machine to run crc (ie, /etc/hosts entries)
  setup: true
  # "stop" and "start" the instance in create sequence - useful for applying configurations without having to recreate the cluster
  restart: true
platforms:
  - name: ocp # All crc clusters are named crc, this variable is not referenced in execution
    pull_secret_file: ../../../../pull-secret.json
    config:
      cpus: 8
      memory: 21504
      disk-size: 45
      preset: openshift
      consent-telemetry: "no"
  # - name: okd # All crc clusters are named crc, this variable is not referenced in execution
  #   config:
  #     bundle: docker://quay.io/crcont/okd-bundle:4.19.0-okd-scos.19
  #     preset: okd
  #     consent-telemetry: "no"

provisioner:
  name: ansible
  inventory:
    host_vars:
      localhost:
        ansible_python_interpreter: '{{ ansible_playbook_python }}'
        # This can probably get rewritten so the user can provide their own path if they desire, but it's challenging to work with because CRC always writes a kubeconfig to the value of the KUBECONFIG environment variable.
        # This also might cause issues using ansible-navigator to run molecule in the future.
        kubeconfig: "{{ lookup('env', 'HOME') + '/.crc/machines/crc/kubeconfig' }}"
        k8s_auth_token: "{{ lookup('file', '/var/run/secrets/kubernetes.io/serviceaccount/token') }}"
        cluster_name: "${MOLECULE_K8S_CLUSTER:-crc}"
        onepassword_vault: molecule-testing
        onepassword_token: "{{ lookup('community.general.onepassword', 'molecule-testing-onepassword-token', field='credential', vault='awx') }}"

  playbooks:
    create: ../shared/playbooks/crc-create.yml
    destroy: ../shared/playbooks/crc-destroy.yml
    converge: converge.yml
    verify: verify.yml

lint: |
  set -e
  yamllint .
  ansible-lint

scenario:
  name: openshift-bootstrap-crc
  create_sequence:
    - dependency
    - create
    - prepare
  destroy_sequence:
    - destroy